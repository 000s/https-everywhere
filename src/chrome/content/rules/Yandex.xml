<!--
	Other Yandex rulests:

		- Loginza.ru.xml
		- Moikrug.ru.xml
		- Ya.ru.xml
		- YaDi.sk.xml
		- Yandex.com.xml
		- Yandex.com.ua.xml
		- Yandex.kz.xml
		- Yandex.net.xml
		- Yandex.st.xml
		- Yandex.ua.xml
		- Yandex.by.xml
		- Yastatic.net.xml


	For any questions please contact Artyom Gavrichenkov <ximaera@yandex.ru>.

	I'm not in any way a Yandex employee, however, this set of rules is
	already working for a long time with all Yandex services, being used very
	intensively, and thus is being shared with community in order to prevent
	scam and stealing from Money.Yandex.ru (and other services as well).

	If you want to know about license terms, here they are:

	DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
	Version 2, December 2004

	Copyright (C) 2004 Sam Hocevar <sam@hocevar.net>

	Everyone is permitted to copy and distribute verbatim or modified
	copies of this license document, and changing it is allowed as long
	as the name is changed.

	DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
	TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION

	0. You just DO WHAT THE FUCK YOU WANT TO.


	Nonfunctional subdomains:

		- m.auto ¹
		- business ²
		- cards ³
		- ir ³
		- iseg ³
		- kassa ⁴
		- (www.)?market ¹
		- narod ²
		- news ³
		- repo ²
		- shad ¹
		- soft ³
		- uslugi ¹
		- wdgt ⁵

	¹ Redirects to http
	² Refused
	³ Dropped
	⁴ Reset
	⁵ 403


	Problematic subdomains:

		- www.advertising ¹
		- collection ²
		- mobile-feedback ³
		- money ⁴

	¹ Mismatched
	² Mismatched, CN: bar.yandex.com.tr
	³ Mismatched, CN: validator.yandex.ru)
	⁴ Blocks Tor users


	Partially covered subdomains:

		- (www.)?	(www → ^)
		- video *

	* Apparently breaks player


	Fully covered subdomains:

		- ((www.)?[^.]+|[^.].[^.]): *	(www → ^)

			- academy
			- (www.)?advertising
			- welcome.advertising
			- afisha
			- an
			- api
			- awaps
			- auto
			- pda.auto
			- ba
			- blogs
			- browsers
			- bs
			- calendar
			- clck
			- company
			- contest
			- algorithm.contest
			- direct
			- disk
			- element
			- events
			- feedback
			- m.feedback
			- feedback2
			- fotki
			- help
			- images
			- img
			- img-fotki
			- kiks
			- legal
			- m.legal
			- mail
	
			- maps
			- m.maps
			- pda.maps

			- partner.market
			- mc
			- mdata
			- metrika
			- mobile
			- money
			- partner
			- pass
			- passport
			- pda-passport
			- people
			- pdd
			- pogoda
			- rabota
			- m.rabota
			- realty
			- research
			- site
			- slovari
			- sprav
			- startups
			- stat
			- taxi
			- tech
			- translate
			- tv
			- video
			- static.video
			- webmaster
			- widgets
			- yabs

			- yaca
			- m.yaca
			- pda.yaca

			- m.zakladki

	* Except where excluded below


	Insecure cookies are set for these domains:

		- .yandex.ru
		- academy.yandex.ru
		- afisha.yandex.ru
		- auto.yandex.ru
		- bs.yandex.ru
		- contest.yandex.ru
		- feedback2.yandex.ru
		- .fotki.yandex.ru
		- mail.yandex.ru
		- partner.market.yandex.ru
		- mobile.yandex.ru
		- pass.yandex.ru
		- pogoda.yandex.ru
		- rabota.yandex.ru
		- m.rabota.yandex.ru
		- realty.yandex.ru
		- slovari.yandex.ru
		- startups.yandex.ru
		- stat.yandex.ru
		- tech.yandex.ru
		- translate.yandex.ru
		- tune.yandex.ru


	Mixed content:

		- Images, on:

			- ba, blogs, maps, partner.market, rabota, yaca from kiks.yandex.ru
			- m.feedback from yastatic.net
			- m.legal from img.yandex.net

		- favicons, on:

			- m.feedback from img.yandex.net
			- legal, m.legal from yandex.st

-->
<ruleset name="Yandex">

	<target host="yandex.ru" />
	<target host="*.yandex.ru" />
		<!--
			Redirects to http:
						-->
		<!--exclusion pattern="^http://yandex\.ru/(video/$)" /-->
		<!--exclusion pattern="^http://m\.auto\.yandex\.ru/$" /-->
		<!--exclusion pattern="^http://market\.yandex\.ru/$" /-->
		<!--exclusion pattern="^http://www\.yandex\.ru/$" /-->
		<!--
			Exceptions:
					-->
		<exclusion pattern="^http://(?:www\.)?yandex\.ru/(?!cycounter(?:$|\?)|images/)" />
		<!--
			Rather than enumerating domains that support SSL,
			we enable SSL for all services and then exclude those
			which become broken:


			1. Public services without HTTPS support (or with broken support):
												-->
		<exclusion pattern="^http://(?:bar-widgets|cards|cs-ellpic|cs-thumb|dict|dzen|encyclopedia|images|lingvo|ll|metro|mirror|music|newmoscow|news|openid|presocial|rasp|twitter|wdgt|weather|wordstat|xml)\.yandex\.ru/" />
		<exclusion pattern="^http://www\.yandex\.ru/(?!cycounter(?:$|\?))" />
		<!--
			Needed for Yandex video player to work:
								-->
		<exclusion pattern="^http://video\.yandex\.ru/iframe/" />
		<exclusion pattern="^http://streaming\.video\.yandex\.ru/" />
		<exclusion pattern="^http://[^.]+\.video\.yandex\.ru/q-upload/" />
		<!--
			2. Simple redirections:
						-->
		<exclusion pattern="^http://probki\.yandex\.ru/" />
		<!--
			3. Narod.ru.
w
		Narod.ru doesn't use auth data from Yandex,
		so we don't need to encrypt its pages.
		The only exception is Narod.Disk, but it doesn't provide HTTPS
							-->
		<exclusion pattern="^http://narod\d*\.yandex\.ru/" />
		<!--
			4. Search suggestions:
						-->
		<exclusion pattern="^http://suggest(?:-[a-z]+)?\.yandex\.ru/" />
		<!--
			5. Webmaster:
					-->
		<exclusion pattern="^http://content\.webmaster\.yandex\.ru/" />
		<!--
			6. Mobile services:
						-->
		<exclusion pattern="^http://m\.yandex\.ru/" />
		<!--
			7. Internet.Yandex.Ru (connection rate detection breaks with HTTPS):
								-->
		<exclusion pattern="^http://internet\.yandex\.ru/" />
		<!--
			8. Various click counters and content stores:
									-->
		<exclusion pattern="^http://(?:copy|hghltd|print|market-click\d+|wrz)\.yandex\.ru/" />
		<!--
			9. Data clusters for Maps and Video:
								-->
		<exclusion pattern="^http://panoramas\.api-maps\.yandex\.ru" />
		<exclusion pattern="^http://(?:jgo|vec\d+|stv\d+)\.maps\.yandex\.ru/" />
		<exclusion pattern="^http://[^.]+-tub(?:-[^.]+)?\.yandex\.ru/" />
		<!--
			10. More subdomains without SSL from Aleksey Kosterin:
										-->
		<exclusion pattern="^http://(?:business|collection|fx|kapersky|keyboard|large|market|nahodki|navigator|online|opera|punto|skype|time|zakladki)\.yandex\.ru/" />
		<!--
			11. Some cert warnings:
						-->
		<exclusion pattern="^http://(?:ie|soft)\.yandex\.ru/" />
		<!--
			Miscellanious:
					-->
		<exclusion pattern="http://(?:m\.auto|www\.market|repo|shad|static-maps|uslugi)\.yandex\.ru/" />



	<!--	Not secured by server:
					-->
	<!--securecookie host="^\.yandex\.ru$" name="^(Cookie_check|fuid01|my|yandexuid|ys)$" /-->
	<!--securecookie host="^(academy|events|startups)\.yandex\.ru$" name="^(express:sess:|express:sess\.sig)$" /-->
	<!--securecookie host="^afisha\.yandex\.ru$" name="^ys$" /-->
	<!--securecookie host="^(auto|pda\.auto|partner\.market|rabota|m\.rabota|realty|slovari|stat)\.yandex\.ru$" name="^uid$" /-->
	<!--securecookie host="^(bs|mc)\.yandex\.ru$" name="^yabs-sid$" /-->
	<!--securecookie host="^contest\.yandex\.ru$" name="^CONTEST_LANG$" /-->
	<!--securecookie host="^feedback2\.yandex\.ru$" name="^feedback2-sid$" /-->
	<!--securecookie host="^\.fotki\.yandex\.ru$" name="^FSession_id$" /-->
	<!--securecookie host="^mail\.yandex\.ru$" name="^ni$" /-->
	<!--securecookie host="^mobile\.yandex\.ru$" name="^family$" /-->
	<!--securecookie host="^pass\.yandex\.ru$" name="^M_\w+_yandex_\w\w$" /-->
	<!--securecookie host="^pogoda\.yandex\.ru$" name="^yw_lc$" /-->
	<!--securecookie host="^realty\.yandex\.ru$" name="^from$" /-->
	<!--securecookie host="^slovari\.yandex\.ru$" name="^slovari-state$" /-->
	<!--securecookie host="^translate\.yandex\.ru$" name="^(first_visit_src|stoken)$" /-->

	<securecookie host="(?:academy|afisha|auto|pda\.auto|bs|contest|events|feedback2|mail|partner\.market|mc|mobile|pass|pogoda|rabota|m\.rabota|realty|slovari|startups|stat|translate|\.video)\.yandex\.ru$" name=".*" />


	<!--	Rewriting rules.
				-->

	<rule from="^http://www\.yandex\.ru/cycounter(?=$|\?)"
		to="https://yandex.ru/cycounter" />

	<rule from="^http://(?:www\.)?([^.]+)\.yandex\.ru/"
		to="https://$1.yandex.ru/" />

	<rule from="^http://yandex\.ru/"
		to="https://yandex.ru/" />

	<!--	Here we can enable 4+ level domains with a single regexp,
		but I've never seen any domains more that 4 levels deep
		in Yandex network, so I wouldn't enable them now -
		it may be unconvenient and may broke some services.
		Only 4-level domains match.
						-->
	<rule from="^http://([^.]+)\.([^.]+)\.yandex\.ru/"
		to="https://$1.$2.yandex.ru/" />


	<!--	"<error><status>401</status><message>Unauthorized</message><cause>Incorrect referer</cause></error>"

		https doesn't give a referrer, so images don't load.

		Example:	https://market.yandex.ru/search.xml?text=draytek&hid=91083&srnum=233
		List:		https://mail1.eff.org/pipermail/https-everywhere-rules/2012-April/001094.html
							-->
	<!--rule from="^https://static-maps\.yandex\.ru/"
		to="http://static-maps.yandex.ru/" downgrade="1" /-->

</ruleset>
