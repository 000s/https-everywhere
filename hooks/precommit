#!/bin/sh
#
#   hooks/precommit hook script of https-everywhere.
#
#   Author: Jonathan Davies <jpdavs@gmail.com>
#

echo "$(date -R): Stashing unrelated changes in Git..."
git stash -q --keep-index

trap 'echo "$(date -R): Reverting Git stash..."; git stash pop -q' EXIT

# Only run tests if our rulesets have been changed.
RULESET_PATTERN="src/chrome/content/rules/"
CHANGED_RULESETS="$(git diff --cached --name-only | grep $RULESET_PATTERN)"

if [ "$CHANGED_RULESETS" ]; then
    echo "$(date -R): Running ruleset validation tests on changed rulesets:"
    ./utils/trivial-validate.py $CHANGED_RULESETS > /dev/null
    RESULT=$?

    if [ $RESULT -eq 1 ]; then
        echo "$(date -R): Failure encountered during ruleset validation."
    else
        echo "$(date -R): Ruleset validation successful."
    fi
else
    echo "$(date -R): Skipped ruleset validation tests, no changes in" \
        "$RULESET_PATTERN."
fi

exit $RESULT
